C51 COMPILER V9.57.0.0   MAIN                                                              07/27/2021 20:57:08 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: E:\keil c51\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "reg52.h"       //此文件中定义了单片机的一些特殊功能寄存器
   2          
   3          typedef unsigned int u16;   //对数据类型进行声明定义
   4          typedef unsigned char u8;
   5           //数码管控制端口
   6          sbit LSA=P2^2;       
   7          sbit LSB=P2^1;
   8          sbit LSC=P2^3;
   9          sbit LSD=P2^4;
  10          
  11          sbit k2=P3^2;//按键控制
  12          sbit k3=P3^3;
  13          
  14          
  15          
  16          sbit led1=P1^0;//南北 绿 
  17          sbit led2=P1^1;//南北 黄 
  18          sbit led3=P1^2; //南北 红
  19          
  20          
  21          sbit led4=P1^3;//东西  绿 
  22          sbit led5=P1^4;//东西 黄
  23          sbit led6=P1^5; //东西 红
  24          
  25          
  26          
  27          u8 code smgduan[17]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,
  28                    0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71};//显示0~F的值
  29          
  30          u8 sum2,sum1=0;
  31          u16 js;//计数变量
  32          u8 aa,bb;     //中间变量
  33          u8 table=0;   //切换标志位
  34          u8 nbshi,dxshi,moshi; //时间中间标记
  35          u8 nbshi1,dxshi1,moshi1; //时间中间标记1
  36          u8 huangshi=3;//黄灯时间
  37          u8 nbzlshi=25;    //南北各灯时间 直行    绿灯       
  38          u8 nbzhshi=30;  //南北各灯时间 直行   红灯
  39              
  40          
  41                    
  42          u8 dxzlshi=25;   //东西各灯时间 直行  绿灯      
  43          u8 dxzhshi=30;  //东西各灯时间  直行  红灯
  44          
  45          
  46          u8 dxhshi,nbhshi;  //南北 东西红灯时间  中间变量
  47          
  48          u8 INT1_1,INT1_0; //中断标志                
  49          /*******************************************************************************
  50          * 函 数 名         : delay
  51          * 函数功能       : 延时函数，i=1时，大约延时10us
  52          *******************************************************************************/
  53          void delay(u16 i)
  54          {
  55   1        while(i--); 
C51 COMPILER V9.57.0.0   MAIN                                                              07/27/2021 20:57:08 PAGE 2   

  56   1      }
  57          
  58          
  59          
  60          /*******************************************************************************
  61          * 函 数 名         : Timer0Init
  62          * 函数功能       : 定时器0初始化
  63          * 输    入         : 无
  64          * 输    出         : 无
  65          *******************************************************************************/
  66          void Timer0Init()
  67          {
  68   1        TMOD|=0X01;//选择为定时器0模式，工作方式1，仅用TR0打开启动。
  69   1      
  70   1        TH0=0XFC; //给定时器赋初值，定时1ms
  71   1        TL0=0X18; 
  72   1        ET0=1;//打开定时器0中断允许
  73   1        EA=1;//打开总中断
  74   1        TR0=1;//打开定时器      
  75   1      }
  76          
  77          void hlhdeng(u8 deng)
  78          {
  79   1        switch(deng)
  80   1            {
  81   2              case 0x00:         //东西直行 绿灯
  82   2                if(sum1==0)
  83   2                led1=1; // 绿     // 南北 灯         
  84   2                led2=1; //黄
  85   2                led3=0; //红  
  86   2                if(sum1==0)
  87   2                led4=0; // 绿       //东西 灯   
  88   2                led5=1; // 黄 
  89   2                led6=1; //红
  90   2            
  91   2              
  92   2                  
  93   2              break;
  94   2              case 0x01:            //东西直行 黄灯
  95   2                  if(sum1==0)
  96   2                 led1=1; // 绿     // 南北 灯         
  97   2                led2=1; //黄
  98   2                led3=0; //红  
  99   2                if(sum1==0)
 100   2                led4=1; // 绿       //东西 灯   
 101   2                led5=0; // 黄 
 102   2                led6=1; //红
 103   2            
 104   2              
 105   2              break;
 106   2              case 0x02:            // 南北 直行 绿
 107   2                if(sum1==0)
 108   2                led1=0; // 绿     // 南北 灯         
 109   2                led2=1; //黄
 110   2                led3=1; //红  
 111   2                if(sum1==0)
 112   2                led4=1; // 绿       //东西 灯   
 113   2                led5=1; // 黄 
 114   2                led6=0; //红
 115   2              break;
 116   2                case 0x03:            // 南北 直行 黄
 117   2                  if(sum1==0)
C51 COMPILER V9.57.0.0   MAIN                                                              07/27/2021 20:57:08 PAGE 3   

 118   2                led1=1; // 绿     // 南北 灯         
 119   2                led2=0; //黄
 120   2                led3=1; //红  
 121   2                 if(sum1==0)
 122   2                led4=1; // 绿       //东西 灯   
 123   2                led5=1; // 黄 
 124   2                led6=0; //红
 125   2              break;
 126   2            
 127   2            }
 128   1      }
 129          /*******************************************************************************
 130          * 函 数 名         : DigDisplay
 131          * 函数功能       : 数码管动态扫描函数，循环扫描8个数码管显示
 132          *******************************************************************************/
 133          
 134          void smg(u8 nbshi,u8 dxshi)
 135          {
 136   1         LSA=1; LSB=1;LSC=0; LSD=1;  
 137   1               
 138   1          aa=nbshi/10;
 139   1          P0=smgduan[aa];
 140   1          delay(50);
 141   1         LSA=1; LSB=1;LSC=1; LSD=0; 
 142   1                    
 143   1          bb=nbshi%10;
 144   1          P0=smgduan[bb];
 145   1          delay(50);
 146   1          
 147   1           LSA=0; LSB=1;LSC=1; LSD=1; 
 148   1          aa=dxshi/10;
 149   1          P0=smgduan[aa];
 150   1          delay(50);
 151   1        
 152   1            LSA=1; LSB=0;LSC=1; LSD=1;               
 153   1          bb=dxshi%10;
 154   1          P0=smgduan[bb];
 155   1          delay(50);
 156   1      
 157   1      }
 158          
 159          void nbzh(u8 nbshi,u8 dxshi,u8 moshi)      //南北直行 黄
 160          {
 161   1        hlhdeng(moshi);   //4种
 162   1      
 163   1        smg(nbshi,dxshi); //南北 东西 
 164   1      
 165   1      }
 166          /*******************************************************************************
 167          * 函 数 名         : Int1Init()
 168          * 函数功能       : 设置外部中断1
 169          * 输    入         : 无
 170          * 输    出         : 无
 171          *******************************************************************************/
 172          void Int0Init()
 173          {
 174   1        //设置INT0
 175   1        IT0=1;//跳变沿出发方式（下降沿）
 176   1        EX0=1;//打开INT0的中断允许。  
 177   1        EA=1;//打开总中断 
 178   1      }
 179          /*******************************************************************************
C51 COMPILER V9.57.0.0   MAIN                                                              07/27/2021 20:57:08 PAGE 4   

 180          * 函 数 名         : Int1Init()
 181          * 函数功能       : 设置外部中断1
 182          * 输    入         : 无
 183          * 输    出         : 无
 184          *******************************************************************************/
 185          void Int1Init1()
 186          {
 187   1        //设置INT1
 188   1        IT1=1;//跳变沿出发方式（下降沿）
 189   1        EX1=1;//打开INT1的中断允许。  
 190   1        EA=1;//打开总中断 
 191   1      }
 192          
 193          /*******************************************************************************
 194          * 函 数 名       : main
 195          * 函数功能     : 主函数
 196          * 输    入       : 无
 197          * 输    出       : 无
 198          *******************************************************************************/
 199          void main()
 200          { 
 201   1        Timer0Init();//定时器中断初始化
 202   1         Int0Init(); // 外部中断0初始化
 203   1         Int1Init1();// 外部中断1初始化
 204   1        nbshi=nbzhshi;  //南北红灯时间
 205   1        dxshi=dxzlshi;  //东西 绿灯  
 206   1        while(1)
 207   1        {
 208   2            if(INT1_0)//中断0
 209   2          {
 210   3            nbzh(nbshi1,dxshi1,moshi1); 
 211   3          }else
 212   2          if(INT1_1)//中断1
 213   2          {
 214   3           nbzh(nbshi1,dxshi1,moshi1);  
 215   3          }else//正常模式
 216   2          {
 217   3            nbzh(nbshi,dxshi,moshi);  
 218   3          }
 219   2           if(sum1)
 220   2            {
 221   3              js++;
 222   3              if(js>=200)
 223   3              {
 224   4                js=0;
 225   4                if(moshi==0)  //东西直行 绿灯
 226   4                led4=!led4;
 227   4                if(moshi==2)  //南北 绿
 228   4                 led1=!led1; 
 229   4                 sum2++;
 230   4              if(sum2>=6){sum1=0;}
 231   4             }
 232   3            }
 233   2        }         
 234   1      }
 235          
 236          
 237          /*******************************************************************************
 238          * 函 数 名         : void Timer0() interrupt 1
 239          * 函数功能       : 定时器0中断函数
 240          * 输    入         : 无
 241          * 输    出         : 无
C51 COMPILER V9.57.0.0   MAIN                                                              07/27/2021 20:57:08 PAGE 5   

 242          *******************************************************************************/
 243          void Timer0() interrupt 1
 244          {
 245   1        static u16 i,j;
 246   1      
 247   1        TH0=0XFC; //给定时器赋初值，定时1ms
 248   1        TL0=0X18;
 249   1      
 250   1        if(INT1_0)//中断0
 251   1          {
 252   2              i++;
 253   2            if(i>=1000)//5S
 254   2            {
 255   3              i=0;
 256   3              if(dxshi1)
 257   3              {
 258   4                nbshi1--;
 259   4                dxshi1--;
 260   4              }else
 261   3              {
 262   4                INT1_0=0;
 263   4              }
 264   3            }
 265   2          }else
 266   1          if(INT1_1)//中断1
 267   1          {
 268   2              i++;
 269   2            if(i>=1000)//10S
 270   2            {
 271   3              i=0;
 272   3              if(dxshi1)
 273   3              {
 274   4                nbshi1--;
 275   4                dxshi1--;
 276   4              }else
 277   3              {
 278   4                INT1_1=0;
 279   4              }
 280   3            }
 281   2          }else//正常模式
 282   1          {
 283   2              i++;
 284   2            if(i==1000)                       //1s进入一次
 285   2            {
 286   3               i=0;     
 287   3                      if(moshi==0)  //东西直行 绿灯
 288   3                      {
 289   4                        if(j==0) //第一次进入
 290   4                        {
 291   5                          j=1;
 292   5                          nbshi=nbzhshi;  //南北红灯时间
 293   5                          dxshi=dxzlshi;  //东西 绿灯  
 294   5                        }else
 295   4                        {
 296   5                          if(dxshi)
 297   5                          {
 298   6                            nbshi--;
 299   6                            dxshi--;
 300   6                          }else
 301   5                          {
 302   6                            if(sum2==0)
 303   6                            sum1=1;
C51 COMPILER V9.57.0.0   MAIN                                                              07/27/2021 20:57:08 PAGE 6   

 304   6                            if(sum1==0)
 305   6                            {
 306   7                              moshi++;
 307   7                              sum2=0;
 308   7                                nbshi--;
 309   7                              dxshi=huangshi;//东西黄灯时间  
 310   7                            }
 311   6                          }
 312   5                        }
 313   4                      }
 314   3                      else
 315   3                       if(moshi==1) //东西 黄
 316   3                      {
 317   4                      
 318   4                        if(dxshi>1)
 319   4                        {
 320   5                          nbshi--;
 321   5                          dxshi--;
 322   5                        }else
 323   4                        {
 324   5                          moshi++;
 325   5                          dxshi--;
 326   5                          nbshi=nbzlshi;  //南北 绿灯时间
 327   5                          dxshi=dxzhshi;  //东西红灯 
 328   5                        }
 329   4                      }else
 330   3                       if(moshi==2) //南北 绿
 331   3                      {
 332   4                       
 333   4                         if(nbshi)
 334   4                        {
 335   5                          nbshi--;
 336   5                           dxshi--;
 337   5                        }else
 338   4                        {
 339   5                          
 340   5                          if(sum2==0)
 341   5                            sum1=1;
 342   5                            if(sum1==0)
 343   5                            {
 344   6                                moshi++;
 345   6                              dxshi--;
 346   6                              sum2=0;
 347   6                              nbshi=huangshi;  
 348   6                            }
 349   5                        }
 350   4                      }else
 351   3                       if(moshi==3) //南北 黄
 352   3                      {
 353   4                         if(nbshi>1)
 354   4                        {
 355   5                           nbshi--;
 356   5                           dxshi--;
 357   5                        }else
 358   4                        {
 359   5                          moshi=0;
 360   5                          dxshi--;
 361   5                            j=0;
 362   5                          nbshi=nbzhshi;  //南北红灯时间
 363   5                          dxshi=dxzlshi;  //东西 绿灯  
 364   5                        }
 365   4                      }
C51 COMPILER V9.57.0.0   MAIN                                                              07/27/2021 20:57:08 PAGE 7   

 366   3                      
 367   3                } 
 368   2              } 
 369   1      }
 370          /*******************************************************************************
 371          * 函 数 名         : Int0() interrupt 0
 372          * 函数功能       : 外部中断0的中断函数
 373          * 输    入         : 无
 374          * 输    出         : 无
 375          *******************************************************************************/
 376          
 377          void Int0() interrupt 0   //外部中断0的中断函数
 378          {
 379   1        delay(1000);   //延时消抖
 380   1        if(k2==0)
 381   1        {
 382   2         INT1_0=1;
 383   2          nbshi1=5;  //南北红灯时间
 384   2          dxshi1=5;  //东西 绿灯  
 385   2          moshi1=0;
 386   2        }
 387   1      }
 388          /*******************************************************************************
 389          * 函 数 名         : Int1() interrupt 2
 390          * 函数功能       : 外部中断0的中断函数
 391          * 输    入         : 无
 392          * 输    出         : 无
 393          *******************************************************************************/
 394          
 395          void Int1() interrupt 2   //外部中断1的中断函数
 396          {
 397   1        delay(1000);   //延时消抖
 398   1        if(k3==0)
 399   1        {
 400   2          INT1_1=1;
 401   2            nbshi1=5;  //南北红灯时间
 402   2          dxshi1=5;  //东西 绿灯 
 403   2         moshi1=2;    
 404   2        }
 405   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    701    ----
   CONSTANT SIZE    =     17    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     26    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
